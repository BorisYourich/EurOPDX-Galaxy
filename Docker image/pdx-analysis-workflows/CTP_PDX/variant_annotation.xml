<tool id="Variant_Annotation" name="Variant Annotation" version="1.0.0">
    <description>tool</description>
    <requirements>
        <requirement type="package" version="4.3.1t"> snpsift </requirement>
        <requirement type="package" version="4.3.1t"> snpeff </requirement>
        <requirement type="package" version="0.1.16"> perl-vcftools-vcf </requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
            #set vcf1='all_genes_variants_microindels.vcf'
            #set vcf2='all_genes_variants_microindels_filtered.vcf'
            #set vcf3='all_genes_variants_microindels_snpEff.vcf'
            #set vcf4='all_genes_variants_microindels_snpEff_snpSift.vcf'
            #set vcf5='all_genes_variants_microindels_snpEff_snpSift_onePerLine.vcf'
            #set vcf6='all_genes_variants_microindels_cosmicannotation.vcf'
            #set vcf7='all_genes_variants_microindels_cosmicannotation_beforeintegenic.vcf'
            #set output1='variants_microIndels.DPfiltered.Annotated.tab'
            #set output2='variants_microIndels.Hardfiltered.Annotated.txt'
	    #if $input.type == "single_dataset"
		cat ${input.in_2} ${input.in_1} | vcf-sort > $vcf1
	    #else
	        cat ${input.in_2.DPfiltered} ${input.in_1.DPfiltered} | vcf-sort > $vcf1
	    #end if	
	    ## Flag algorithmically identified false positive variants and variants with Allele Frequency < 5%.
            && SnpSift -Xmx8G filter --addFilter "lowAF" --rmFilter "PASS" 'ALT_AF[ANY] < 5' $vcf1 > $vcf2

            ##snpEff -Xmx8G eff -v -lof -onlyTr  {transcript_list} -hgvs GRCh38.84 -noStats $vcf2 > $vcf3 &&
            && snpEff -Xmx8G eff -v -lof -hgvs GRCh38.86 -noStats $vcf2 > $vcf3

            && SnpSift -Xmx8G dbnsfp -v -db "/mnt/volume/shared/ext-data-library/CTP-seq/dbNSFP3.2a.txt.gz" -f SIFT_score,SIFT_pred,Polyphen2_HDIV_score,MutationAssessor_score,phyloP100way_vertebrate,1000Gp3_AF,1000Gp3_AFR_AF,1000Gp3_EUR_AF,1000Gp3_AMR_AF,1000Gp3_EAS_AF,ESP6500_AA_AF,ESP6500_EA_AF,ExAC_AC,ExAC_AF $vcf3 > $vcf4
            && cat $vcf4 | perl '${__tool_directory__}/bin/snpSift_onePerLine.pl' > $vcf5

            ## Add COSMIC annotation
            && SnpSift -Xmx8G annotate -id "/mnt/volume/shared/ext-data-library/CTP-seq/Sorted_Cosmic_Coding_and_Noncoding.vcf" $vcf5 > $vcf6
	    && SnpSift -Xmx8G extractFields $vcf6 "EFF[*].GENE" "EFF[*].BIOTYPE" "EFF[*].CODON" SVTYPE "EFF[*].AA" "EFF[*].EFFECT" DP_HQ ALT_AF CHROM POS REF ALT "ANN[*].GENEID" "EFF[*].TRID" ID > $output1
	    && python '${__tool_directory__}/bin/clean_intergenic_region_gene_names.py' -f $output1 -d

            && cat $output1 | awk -F '\t' 'BEGIN {OFS="\t"} $6 == "FILTER" || $6 == "PASS" || $6 == "" || $6 == "."' > $output2
        ]]>
    </command>
    <inputs>
        <conditional name="input">
            <param name="type" type="select" label="Input Type">
                <option value="single_dataset" selected="true">Single (Sample)</option>
                <option value="sample_collection" >Collection (Multiple Samples)</option>
            </param>
            <when value="single_dataset">
                <param format="vcf" name="in_1" type="data" label="MicroIndels DPfiltered 2"
                       help="This dataset is generated by Variant Filtration Pindel tool."/>
                <param format="vcf" name="in_2" type="data" label="Variants DPfiltered"
                       help="This dataset is generated by Variant Filtration tool."/>
            </when>
            <when value="sample_collection">
                <param name="in_1" type="data_collection" collection_type="list"
                       label="Select MicroIndels DPfiltered 1 Collection"
                       help="Specify MicroIndels DPfiltered 1 dataset collection."/>
       		<param name="in_2"  type="data_collection" collection_type="list"
                       label="Select Variants DPfiltered Collection"
                       help="Specify  Variants DPfiltered collection."/>
            </when>
        </conditional>
	<!--<param format="vcf" name="in_3" type="data" label="Sorted Cosmic Coding Noncoding" help="This dataset is generated by Sorted Cosmic Coding and Noncoding tool."/>
	<param format="txt" name="in_4" type="text" label="dbNSFP Path" value="/home/pdxuser/hg38/dbNSFP3.2a.txt.gz" help="Downloaded from https://sites.google.com/site/jpopgen/dbNSFP"/>-->
    </inputs>
    <outputs>
        <data name="out_1" format="tabular" from_work_dir="variants_microIndels.DPfiltered.Annotated.tab" label="Variants microIndels DPfiltered Annotated">
	<filter>input['type'] == 'single_dataset'</filter>
        </data>
        <data name="out_2" format="tabular" from_work_dir="variants_microIndels.Hardfiltered.Annotated.txt" label="Variants microIndels Hardfiltered Annotated">
             <filter>input['type'] == 'single_dataset'</filter>
        </data>

        <collection name="list_output" type="list" label="Variants Annotated Collection">
            <data name="DPfiltered" format="tabular" from_work_dir="variants_microIndels.DPfiltered.Annotated.tab" hidden="true"/>
	    <data name="Hardfilterd" format="tabular" from_work_dir="variants_microIndels.Hardfiltered.Annotated.txt" hidden="true"/>
	    <filter>input['type'] == 'sample_collection'</filter>
        </collection>
    </outputs>

    <help>
        Annotate variants with snpEff and SnpSift.

        This tool has following input and output dataset or collection.

        Inputs:

        1) Input Type:

            Dataset Collection (Multiple samples): Variants DPfiltered (VCF) and MicroIndels DPfiltered 1 (VCF) Collections. Generated by Variant Filtration and MicroIndel Calling tool.

            Single Dataset (Single sample): Variants DPfiltered (VCF) and MicroIndels DPfiltered 1 (VCF) Dataset. Generated by Variant Filtration and MicroIndel Calling tool.

        2) Sorted Cosmic Coding Noncoding (VCF)

        Outputs:

        Based on the input selection, following will be output(s).

        1) Variants microIndels DPfiltered Annotated (Tab)

        2) Variants microIndels Hardfiltered Annotated (Tab)

    </help>
</tool>
