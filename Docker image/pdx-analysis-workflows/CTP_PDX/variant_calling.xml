<tool id="Variant_Caller" name="Variant Caller" version="1.0.0">
    <description>tool using UnifiedGenotyper</description>
    <requirements>
        <requirement type="package" version="2.21.8"> picard </requirement>
        <requirement type="package" version="3.8"> gatk </requirement>
        <requirement type="package" version="1.3"> samtools </requirement>
        <requirement type="package" version="0.1.16"> perl-vcftools-vcf </requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
	    #if $input.type == "single_dataset"
                ln -fs "$input.in_1" input.bam
            #else
                ln -fs "$input.in_1.realigned_BQSR" input.bam
            #end if
	    
	    #set ref_name="/mnt/volume/shared/ext-data-library/CTP-seq/Homo_sapiens_assembly38.fasta"
            #set dict_name="/mnt/volume/shared/ext-data-library/CTP-seq/Homo_sapiens_assembly38.dict"
	    
	    ## Create index file
            && samtools index input.bam

            ## Apply functions
            && gatk3 "-Xmx8G" -T UnifiedGenotyper \
            -I input.bam \
            -R $ref_name \
            --dbsnp $in_3 \
            -glm BOTH \
            -o raw_gatk.vcf
            -stand_call_conf 50.0 \
            -dt NONE \
            --sample_ploidy 4 \
            --disable_auto_index_creation_and_locking_when_reading_rods

            && gatk3 "-Xmx8G" -T SelectVariants \
            -R $ref_name \
            -V raw_gatk.vcf \
            -selectType SNP \
            -o raw_snps.vcf

            && gatk3 "-Xmx8G" -T SelectVariants \
            -R $ref_name \
            -V raw_gatk.vcf \
            -selectType INDEL \
            -o raw_indels.vcf

            && gatk3 "-Xmx8G" -T VariantFiltration \
            -R $ref_name
            --variant raw_snps.vcf \
            --clusterSize 3 \
            --clusterWindowSize 10 \
            --filterExpression "QD < 2.0" --filterName "lowQD" \
            --filterExpression "FS > 60.0" --filterName "strandbias" \
            --filterExpression "MQ < 40.0" --filterName "lowMQ" \
            --filterExpression "MQRankSum < -12.5" --filterName "lowMQRankSum" \
            --filterExpression "ReadPosRankSum < -8.0" --filterName "lowReadPosRankSum" \
            -o filtered_snps.vcf

            && gatk3 "-Xmx8G" -T VariantFiltration \
            -R $ref_name
            --variant raw_indels.vcf \
            --filterExpression "QD < 2.0" --filterName "lowQD" \
            --filterExpression "FS > 200.0" --filterName "strandbias" \
            --filterExpression "ReadPosRankSum < -20.0" --filterName "lowReadPosRankSum"  \
            -o filtered_indels.vcf

            && cat filtered_snps.vcf filtered_indels.vcf | vcf-sort > variants.raw.vcf
        ]]>
    </command>
    <inputs>
	    <param format="vcf" name="in_3" type="hidden" value="/mnt/volume/shared/ext-data-library/CTP-seq/Homo_sapiens_assembly38.dbsnp138.vcf"/>
	    <!--<param format="fasta" name="in_2" type="data" label="Human Reference File" help="Downloaded from https://storage.cloud.google.com/genomics-public-data/resources/broad/hg38/v0/Homo_sapiens_assembly38.fasta"/>-->
        <conditional name="input">
            <param name="type" type="select" label="Input Type">
                <option value="single_dataset" selected="true">Single (Sample)</option>
                <option value="sample_collection" >Collection (Multiple Samples)</option>
            </param>
            <when value="single_dataset">
                <param format="bam" name="in_1" type="data" label="Realigned BQSR"
                       help="This dataset is generated by Variant Pre-processing tool."/>
            </when>
            <when value="sample_collection">
                <param name="in_1" type="data_collection" collection_type="list"
                       label="Select Realigned BQSR Collection"
                       help="Specify Realigned BQSR Dataset collection."/>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data name="out_1" format="vcf" from_work_dir="variants.raw.vcf" label="Variants Raw">
             <filter>input['type'] == 'single_dataset'</filter>
        </data>
        <collection name="list_output" type="list" label="Variants Raw Collection">
            <data name="Variants_raw" format="vcf" from_work_dir="variants.raw.vcf" hidden="true"/>
	    <data name="filtered_indels" format="vcf" from_work_dir="filtered_indels.vcf" hidden="true"/>
	    <filter>input['type'] == 'sample_collection'</filter>
        </collection>
    </outputs>

    <help>
        Calling first pass filtering of the variants from our pre-processed BAM file using GATK unifiedGenotyper and GATK variantFiltration, respectively

        This tool has following input and output dataset/collections.

        Inputs:

        1) Input Type:

            Dataset Collection (Multiple samples): Realigned BQSR BAM Collection. Generated by Variant Pre-processing tool.

            Single Dataset (Single sample): Realigned BQSR BAM Dataset. Generated by Variant Pre-processing tool.

        2) Human Reference File

        3) Homo_sapiens_assembly38.dbsnp138.vcf

        Outputs:

        Based on the input selection, following will be output.

        1) Variants Raw (VCF)
    </help>
</tool>
