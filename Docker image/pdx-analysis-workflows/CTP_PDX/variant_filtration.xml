<tool id="Variant_Filtration" name="Variant Filtration" version="1.0.0">
    <description>tool</description>
    <requirements>
        <requirement type="package" version="4.3.1t"> snpsift </requirement>
        <requirement type="package" version="0.2.6">tabix</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
            #set vcf1='DPfiltered.tmp.vcf'
	    #set vcf2='additionalfilters.tmp.vcf'
	    #set vcf3='variants.tmp.vcf'
            #set vcf_out='variants.DPfiltered.vcf'

            ## Compute coverage depth by adding allele counts. Compute allele frequencies from allele counts.
            ## Filter out any reads that don't have a minimum coverage of 140.
	    #if $input.type == "single_dataset"
                python '${__tool_directory__}/bin/allele_depth_min_and_AF_from_ADs.py' ${input.in_1} $vcf1 140
            #else
                python '${__tool_directory__}/bin/allele_depth_min_and_AF_from_ADs.py' ${input.in_1.Variants_raw} $vcf1 140
            #end if
            && SnpSift -Xmx8G annotate -id $in_2 $vcf1 > $vcf2
            ##SnpSift -Xmx8G annotate -id $in_2 ${input_type.in_1} > $vcf2

            ## Flag algorithmically identified false positive variants and variants with Allele Frequency < 5%.
	    && SnpSift -Xmx8G filter --addFilter "lowAF" --rmFilter "PASS" 'ALT_AF[ANY] < 5' $vcf2 > $vcf_out
	    ]]>
    </command>
    <inputs>
        <param format="vcf" name="in_2" type="hidden" value="/mnt/volume/shared/ext-data-library/CTP-seq/Homo_sapiens_assembly38.dbsnp138.vcf"/>
        <conditional name="input">
            <param name="type" type="select" label="Input Type">
                <option value="single_dataset" selected="true">Single (Sample)</option>
                <option value="sample_collection" >Collection (Multiple Samples)</option>
            </param>
            <when value="single_dataset">
                <param format="vcf" name="in_1" type="data" label="Variants Raw (VCF)"
                       help="This dataset is generated by Variant Calling tool."/>
            </when>
            <when value="sample_collection">
                <param name="in_1" type="data_collection" collection_type="list"
                       label="Select Variants Raw (VCF) Collection"
                       help="Specify Variants Raw (VCF) dataset collection."/>
            </when>
        </conditional>
	<param format="txt" name="in_3" type="hidden" value="static" label="static"/>
    </inputs>
    <outputs>
        <data name="out_1" format="vcf" from_work_dir="variants.DPfiltered.vcf" label="Variants DPfiltered">
             <filter>input['type'] == 'single_dataset'</filter>
        </data>

        <collection name="list_output" type="list" label="Variants DPfiltered Collection">
            <data name="DPfiltered" format="vcf" from_work_dir="variants.DPfiltered.vcf" hidden="true"/>
            <data name="static" format_source="in_3" hidden="true"/>
            <filter>input['type'] == 'sample_collection'</filter>
        </collection>
    </outputs>
    <help>
        Filter variants using depth and allele frequency cut-off.

        This tool has following input and output dataset/collections.

        Inputs:

        1) Input Type:

            Dataset Collection (Multiple samples): Variants Raw Collection. Generated by Variant Calling tool.

            Single Dataset (Single sample): Variants Raw Dataset. Generated by Variant Calling tool.

        2) Homo_sapiens_assembly38.dbsnp138.vcf

        Outputs:

        Based on the input selection, following will be output.

        1) Variants DPfiltered (VCF)

    </help>
</tool>
