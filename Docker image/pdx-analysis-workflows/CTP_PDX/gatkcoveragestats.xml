<tool id="gatk_coverage_ctp_stats" name="Compile GATK Coverage Stats" version="1.0.0">
    <description>tool</description>
        <requirements>
        <requirement type="package" version="3.8"> gatk </requirement>
    </requirements>
    <stdio>
         <exit_code range="1:" level="fatal" />
    </stdio>
    <command>
        <![CDATA[
            #set input_bam_file=str($input_type.in_1)+'.bam'
            #set ref_name=str($in_2)+'.fa'
            #set dict_name=str($in_2)+'.dict'
            #set interval_list=str($in_3)+'.interval_list'
            echo $input_bam_file &&

            ## Create a soft link for Reference and BAM file(s)
            ln -fs ${input_type.in_1} $input_bam_file &&
            ln -fs $in_2 $ref_name &&
            ln -fs $in_3 $interval_list &&

            ## Register gatk3 jar file (TODO: Need to grab jar file at Galaxy installation)
            gatk3-register /mnt/volume/shared/ext-data-library/CTP-seq/GenomeAnalysisTK-3.8-0-ge9d806836/GenomeAnalysisTK.jar &&

            gatk3 "-Xmx8G" -T DepthOfCoverage \
            -I $input_bam_file \
            -R $ref_name \
            --outputFormat table \
            -o gatk_temp1.txt  \
            --omitPerSampleStats \
            --omitIntervalStatistics \
            --omitLocusTable

            ##sh '${__tool_directory__}/bin/gatk_formatter.sh' gatk_temp1.txt gatk_temp2.txt gatk_temp3.txt $in_3 &&

            ##python '${__tool_directory__}/bin/coveragecalculator.py' gatk_temp3.txt targetinterval_avg_median_coverage.bed
        ]]>
    </command>
    <inputs>
        <conditional name="input_type">
            <param name="add" type="select" label="Input Type">
                <option value="single_dataset" selected="true">Single (Sample)</option>
                <option value="sample_collection" >Collection (Multiple Samples)</option>
            </param>
            <when value="single_dataset">
                <param format="bam" name="in_1" type="data" label="Realigned BQSR"
                       help="This dataset is generated by Variant Pre-processing tool."/>
            </when>
            <when value="sample_collection">
                <param name="in_1" format="bam" type="data_collection" collection_type="list"
                       label="Select MicroIndels DPfiltered 1 Collection"
                       help="Specify MicroIndels DPfiltered 1 dataset collection."/>
            </when>
        </conditional>
        <param format="fasta" name="in_2" type="data" label="Human Reference File" help="Downloaded from https://storage.cloud.google.com/genomics-public-data/resources/broad/hg38/v0/Homo_sapiens_assembly38.fasta"/>
        <param format="bed" name="in_3" type="data" label="Target Interval List" help="First LeftOver hg19 to hg38 (.bed file downloaded from https://emea.support.illumina.com/downloads/nextera-rapid-capture-exome-v1-2-product-files.html) using https://genome.ucsc.edu/cgi-bin/hgLiftOver"/>
    </inputs>
    <outputs>
        <data name="out_1" format="txt" from_work_dir="gatk_temp1.txt" label="Target Interval Coverage">
             <filter>input_type['add'] == 'single_dataset'</filter>
        </data>

        <collection name="list_output" type="list" label="Summary Stats Collection">
            <data name="summary_stats" format="txt" from_work_dir="summary_stats.txt" hidden="true"/>
            <filter>input_type['add'] == 'sample_collection'</filter>
        </collection>
    </outputs>

    <help>
        Compile alignment QC, duplication metrics and coverage statistics into a single file.

        This tool has following input and output dataset or collections.

        Inputs:

        1) Realigned BQSR (BAM)

        2) Human Reference

        3) Target Interval List

        Outputs:

        Based on the input selection, following will be output(s).

        1) Summary statistics file

    </help>
</tool>

