<tool id="pindel" name="Pindel Caller" version="1.0.0">
    <description>tool</description>
    <requirements>
        <requirement type="package" version="2.29.2">bedtools</requirement>
        <requirement type="package" version="1.3">samtools</requirement>
        <requirement type="package" version="0.2.5b9">pindel</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
	    #if $input.type == "single_dataset"
                ln -fs "$input.in_1" input.bam
            #else
                ln -fs "$input.in_1.realigned_BQSR" input.bam
            #end if
            ## Create index file
            && samtools index input.bam
            ## Create index file for reference genome
            #if os.path.exists(str($in_3)+'.fai')
                && echo "[INFO] reference .fai exists"
            #else
                && samtools faidx $in_3
                && echo "[INFO] reference .fai created"
            #end if

            && echo -e "input.bam\t350\t$in_2" > pindel_config.txt

            && pindel --config-file pindel_config.txt --fasta "$in_3" -o "$in_2"

            && cat "$in_2"_D "$in_2"_SI > "$in_2"_DSI

            && pindel2vcf -p "$in_2"_DSI -r "$in_3" -R hg38 -d 20150925 --max_size 50 --vcf microIndels_all.txt -G --het_cutoff 0.05

            && bedtools intersect -header -a microIndels_all.txt -b "$in_4" -f 1.0 > microIndels.raw.vcf

            && python3 '${__tool_directory__}/bin/filter_for_minimum_depth' microIndels.raw.vcf microIndels.DPfiltered1.vcf
        ]]>
    </command>
    <inputs>
        <conditional name="input">
            <param name="type" type="select" label="Input Type">
                <option value="single_dataset" selected="true">Single (Sample)</option>
                <option value="sample_collection" >Collection (Multiple Samples)</option>
            </param>
            <when value="single_dataset">
                <param format="bam" name="in_1" type="data" label="Realigned BQSR (BAM)"
                       help="This dataset is generated by Variant Pre-processing tool."/>
            </when>
            <when value="sample_collection">
                <param name="in_1" type="data_collection" collection_type="list"
                       label="Select Realigned BQSR (BAM) Collection"
                       help="Specify Realigned BQSR (BAM) dataset collection."/>
            </when>
        </conditional>
        <param format="txt" name="in_2" type="hidden" value="Sample"/>
        <param format="fasta" name="in_3" type="hidden" value="/mnt/volume/shared/ext-data-library/CTP-seq/Homo_sapiens_assembly38.fasta" help="Downloaded from https://storage.cloud.google.com/genomics-public-data/resources/broad/hg38/v0/Homo_sapiens_assembly38.fasta"/>
        <param format="bed" name="in_4" type="hidden" value="/mnt/volume/shared/ext-data-library/CTP-seq/hglft_genome_65a93_7d8520.bed" help="First LeftOver hg19 to hg38 (.bed file downloaded from https://emea.support.illumina.com/downloads/nextera-rapid-capture-exome-v1-2-product-files.html) using https://genome.ucsc.edu/cgi-bin/hgLiftOver"/>
    </inputs>
    <outputs>
	<data name="raw" format="vcf" from_work_dir="microIndels.raw.vcf" label="MicroIndels Raw">
	    <filter>input['type'] == 'single_dataset'</filter>
	</data>
	<data name="dp" format="vcf" from_work_dir="microIndels.DPfiltered1.vcf" label="MicroIndels DPfiltered 1">
	    <filter>input['type'] == 'single_dataset'</filter>
	</data>

        <collection name="list_output" type="list" label="MicroIndels DP Filtered">
            <data name="microIndels_raw" format="vcf" from_work_dir="microIndels.raw.vcf" hidden="true"/>
            <data name="microIndels_DP" format="vcf" from_work_dir="microIndels.DPfiltered1.vcf" hidden="true"/>
            <filter>input['type'] == 'sample_collection'</filter>
        </collection>
    </outputs>
    <help>
        Call micro INDELs from our pre-processed BAM file in Variant Pre-processing Tool.

        This tool has following input and output dataset/collections.

        Inputs:

        1) Input Type:

            Dataset Collection (Multiple samples): Variants DPfiltered (VCF) Collection. Generated by Variant Filtration tool.

            Single Dataset (Single sample): Variants DPfiltered (VCF) Dataset. Generated by Variant Filtration tool.

        2) Human Reference File

        3) Sample Name

        4) Target Interval List

        Outputs:

        Based on the input selection, following will be output(s).

        1) MicroIndels Raw (VCF)

        2) MicroIndels DPfiltered 1 (VCF)

    </help>
</tool>
